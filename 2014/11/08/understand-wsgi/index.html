<!DOCTYPE html>
<html CN>







<head>
	
	
	<link rel="stylesheet" href="/css/allinone.min.css"> 

	

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<title>python wsgi 简介 | Cizixs Write Here</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="Cizixs Wu">
	<meta name="description" content="">

	
	<meta name="keywords" content="">
	

	
	<link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png">
	

	
	<meta name="theme-color" content="#3c484e">
	<meta name="msapplication-TileColor" content="#3c484e">
	

	

	

	<meta property="og:site_name" content="Cizixs Write Here">
	<meta property="og:type" content="article">
	<meta property="og:title" content="python wsgi 简介 | Cizixs Write Here">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://cizixs.com/2014/11/08/understand-wsgi/">

	
	<meta property="article:published_time" content="2014-11-08T00:11:00+08:00"/> 
	<meta property="article:author" content="Cizixs Wu">
	<meta property="article:published_first" content="Cizixs Write Here, /2014/11/08/understand-wsgi/" />
	

	
	
	<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
	

	
	<script src="https://cdn.staticfile.org/highlight.js/9.10.0/highlight.min.js"></script>
	

	
	
</head>
<body class="post-template">
    <div class="site-wrapper">
        




<header class="site-header outer" style="z-index: 999">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">Home</a>
                
            </li>
            
            
            <li>
                <a href="/about" title="About">About</a>
            </li>
            
            <li>
                <a href="/archives" title="Archives">Archives</a>
            </li>
            
            
        </ul> 
    </div>
    <div class="site-nav-right">
        
<div class="social-links" >
    
    
    
    
    <a class="social-link" title="twitter" href="https://twitter.com/cizixs" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

    </a>
    
    
</div>
    </div>
</nav>
    </div>
</header>


<main id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <section class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2014-11-07T16:00:00.000Z" itemprop="datePublished">
                    2014-11-8
                </time>
                
                <span class="date-divider">/</span>
                
                <a href="/categories/程序技术/">程序技术</a>&nbsp;&nbsp;
                
                
            </section>
            <h1 class="post-full-title">python wsgi 简介</h1>
        </header>
        <article class="post-full no-image">
            
            <section class="post-full-content">
                <div id="lightgallery" class="markdown-body">
                    <h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="Python-知识"><a href="#Python-知识" class="headerlink" title="Python 知识"></a>Python 知识</h3><ul>
<li>iterator 和 generator</li>
<li>函数的高级用法：嵌套函数，作为参数传递等等</li>
<li>了解 decorator 会对理解 wsgi 有很大的帮助</li>
<li>python 的 callable 概念</li>
<li>classmethod 和 staticmethod 的概念</li>
<li>web 编程的基础</li>
</ul>
<h3 id="HTTP-基础"><a href="#HTTP-基础" class="headerlink" title="HTTP 基础"></a>HTTP 基础</h3><p><img src="http://ww4.sinaimg.cn/large/005yyi5Jjw1em3fj419m7j30i40g8gm5.jpg" alt="http"></p>
<p>对于 web 应用程序来说，最基本的概念就是客户端发送请求（request），收到服务器端的响应（response）。</p>
<p>下面是简单的 HTTP 请求：</p>
<pre><code>GET /Index.html HTTP/1.1\r\n
Connection: Keep-Alive\r\n
Accept: */*\r\n
User-Agent: Sample Application\r\n
Host: www.microsoft.com\r\n\r\n
</code></pre><p>内容包括了 method、 url、 protocol version 以及头部的信息。而 HTTP 响应（不包括数据）可能是如下的内容：</p>
<pre><code>HTTP/1.1 200 OK
Server: Microsoft-IIS/5.0\r\n
Content-Location: http://www.microsoft.com/default.htm\r\n
Date: Tue, 25 Jun 2002 19:33:18 GMT\r\n
Content-Type: text/html\r\n
Accept-Ranges: bytes\r\n
Last-Modified: Mon, 24 Jun 2002 20:27:23 GMT\r\n
Content-Length: 26812\r\n
</code></pre><p>实际生产中，python 程序是放在服务器的 http server（比如 apache， nginx 等）上的。现在的问题是 <strong>服务器程序怎么把接受到的请求传递给 python 呢，怎么在网络的数据流和 python 的结构体之间转换呢？</strong>这就是 wsgi 做的事情：一套关于程序端和服务器端的规范，或者说统一的接口。</p>
<p><img src="http://ww2.sinaimg.cn/large/005yyi5Jjw1em3l4rsqdbj30ue0g80tz.jpg" alt=""></p>
<h2 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h2><p>我们先看一下面向 http 的 python 程序需要关心哪些内容：</p>
<ul>
<li>请求<ul>
<li><strong>请求的方法 method</strong></li>
<li><strong>请求的地址 url</strong></li>
<li><strong>请求的内容</strong></li>
<li>请求的头部 header</li>
<li>请求的环境信息</li>
</ul>
</li>
<li>响应<ul>
<li><strong>状态码 status_code</strong></li>
<li><strong>响应的数据</strong></li>
<li>响应的头部</li>
</ul>
</li>
</ul>
<p>WSGI（Web Server Gateway Interface） 的任务就是把上面的数据在 http server 和 python 程序之间简单友好地传递。它是一个标准，被定义在<a href="http://legacy.python.org/dev/peps/pep-0333/#rationale-and-goals" target="_blank" rel="noopener">PEP 333</a>。需要 http server 和 python 程序都要遵守一定的规范，实现这个标准的约定内容，才能正常工作。</p>
<p><img src="http://www.fullstackpython.com/theme/img/wsgi-interface.png" alt="wsgi"></p>
<h3 id="应用程序端"><a href="#应用程序端" class="headerlink" title="应用程序端"></a>应用程序端</h3><p>WSGI 规定每个 python 程序（Application）必须是一个可调用的对象（实现了<code>__call__</code> 函数的方法或者类），接受两个参数 <code>environ</code>（WSGI 的环境信息） 和 <code>start_response</code>（开始响应请求的函数），并且返回 iterable。几点说明：</p>
<ol>
<li><code>environ</code> 和 <code>start_response</code> 由 http server 提供并实现</li>
<li><code>environ</code> 变量是包含了环境信息的字典</li>
<li><code>Application</code> 内部在返回前调用 <code>start_response</code></li>
<li><code>start_response</code>也是一个 callable，接受两个必须的参数，<code>status</code>（HTTP状态）和 <code>response_headers</code>（响应消息的头）</li>
<li>可调用对象要返回一个值，这个值是可迭代的。</li>
</ol>
<p>说了这么多的概念，再来看看代码的实现：</p>
<pre><code> # 1. 可调用对象是一个函数
def application(environ, start_response):

   response_body = &apos;The request method was %s&apos; % environ[&apos;REQUEST_METHOD&apos;]

   # HTTP response code and message
   status = &apos;200 OK&apos;

   # 应答的头部是一个列表，每对键值都必须是一个 tuple。
   response_headers = [(&apos;Content-Type&apos;, &apos;text/plain&apos;),
                       (&apos;Content-Length&apos;, str(len(response_body)))]

   # 调用服务器程序提供的 start_response，填入两个参数
   start_response(status, response_headers)

   # 返回必须是 iterable
   return [response_body]    

# 2. 可调用对象是一个类
class AppClass:
    &quot;&quot;&quot;这里的可调用对象就是 AppClass 这个类，调用它就能生成可以迭代的结果。
        使用方法类似于： 
        for result in AppClass(env, start_response):
             do_somthing(result)
    &quot;&quot;&quot;

    def __init__(self, environ, start_response):
        self.environ = environ
        self.start = start_response

    def __iter__(self):
        status = &apos;200 OK&apos;
        response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;)]
        self.start(status, response_headers)
        yield &quot;Hello world!\n&quot;

# 3. 可调用对象是一个实例 
class AppClass:
    &quot;&quot;&quot;这里的可调用对象就是 AppClass 的实例，使用方法类似于： 
        app = AppClass()
        for result in app(environ, start_response):
             do_somthing(result)
    &quot;&quot;&quot;

    def __init__(self):
        pass

    def __call__(self, environ, start_response):
        status = &apos;200 OK&apos;
        response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;)]
        self.start(status, response_headers)
        yield &quot;Hello world!\n&quot;
</code></pre><h3 id="服务器程序端"><a href="#服务器程序端" class="headerlink" title="服务器程序端"></a>服务器程序端</h3><p>上面已经说过，标准要能够确切地实行，必须要求程序端和服务器端共同遵守。上面提到， <code>envrion</code> 和 <code>start_response</code> 都是服务器端提供的。下面就看看，服务器端要履行的义务。</p>
<ul>
<li>准备 <code>environ</code> 参数</li>
<li>定义 <code>start_response</code> 函数</li>
<li>调用程序端的可调用对象</li>
</ul>
<p>PEP 333 里给出了一个 wsgi server 的简单实现，我又简化了一下——去除一些异常处理和判断，添加了一点注释：</p>
<pre><code>import os, sys

def run_with_cgi(application):    # application 是程序端的可调用对象
    # 准备 environ 参数，这是一个字典，里面的内容是一次 HTTP 请求的环境变量
    environ = dict(os.environ.items())
    environ[&apos;wsgi.input&apos;]        = sys.stdin
    environ[&apos;wsgi.errors&apos;]       = sys.stderr
    environ[&apos;wsgi.version&apos;]      = (1, 0)
    environ[&apos;wsgi.multithread&apos;]  = False
    environ[&apos;wsgi.multiprocess&apos;] = True
    environ[&apos;wsgi.run_once&apos;]     = True            
    environ[&apos;wsgi.url_scheme&apos;] = &apos;http&apos;

    headers_set = []
    headers_sent = []

    # 把应答的结果输出到终端
    def write(data):
        sys.stdout.write(data)
        sys.stdout.flush()

    # 实现 start_response 函数，根据程序端传过来的 status 和 response_headers 参数，
    # 设置状态和头部
    def start_response(status, response_headers, exc_info=None):
        headers_set[:] = [status, response_headers]
          return write

    # 调用客户端的可调用对象，把准备好的参数传递过去
    result = application(environ, start_response)

    # 处理得到的结果，这里简单地把结果输出到标准输出。
    try:
        for data in result:
            if data:    # don&apos;t send headers until body appears
                write(data)
    finally:
        if hasattr(result, &apos;close&apos;):
            result.close()
</code></pre><h3 id="中间层-middleware"><a href="#中间层-middleware" class="headerlink" title="中间层 middleware"></a>中间层 middleware</h3><p>有些程序可能处于服务器端和程序端两者之间：对于服务器程序，它就是应用程序；而对于应用程序，它就是服务器程序。这就是中间层 middleware。middleware 对服务器程序和应用是透明的，它像一个代理/管道一样，把接收到的请求进行一些处理，然后往后传递，一直传递到客户端程序，最后把程序的客户端处理的结果再返回。如下图所示：</p>
<p><img src="http://ww4.sinaimg.cn/large/005yyi5Jjw1em2p14p5z9j30rs0cqwg1.jpg" alt=""></p>
<p>middleware 做了两件事情：</p>
<ol>
<li>被服务器程序（有可能是其他 middleware）调用，返回结果回去</li>
<li>调用应用程序（有可能是其他 middleware），把参数传递过去</li>
</ol>
<p>PEP 333 上面给出了 middleware 的可能使用场景：</p>
<ul>
<li>根据 url 把请求给到不同的客户端程序（url routing）</li>
<li>允许多个客户端程序/web 框架同时运行，就是把接到的同一个请求传递给多个程序。</li>
<li>负载均衡和远程处理：把请求在网络上传输</li>
<li>应答的过滤处理 </li>
</ul>
<p>那么简单地 middleware 实现是怎么样的呢？下面的代码实现的是一个简单地 url routing 的 middleware：</p>
<pre><code>class Router(object):
    def __init__(self):
        self.path_info = {}
    def route(self, environ, start_response):
        application = self.path_info[environ[&apos;PATH_INFO&apos;]]
        return application(environ, start_response)
    def __call__(self, path):
        def wrapper(application):
            self.path_info[path] = application
        return wrapper

router = Router()
</code></pre><p>怎么在程序里面使用呢？</p>
<pre><code>#here is the application
@router(&apos;/hello&apos;)    #调用 route 实例，把函数注册到 paht_info 字典
def hello(environ, start_response):
    status = &apos;200 OK&apos;
    output = &apos;Hello&apos;
    response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),
                        (&apos;Content-Length&apos;, str(len(output)))]
    write = start_response(status, response_headers)
    return [output]

@router(&apos;/world&apos;)
def world(environ, start_response):
    status = &apos;200 OK&apos;
    output = &apos;World!&apos;
    response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),
                        (&apos;Content-Length&apos;, str(len(output)))]
    write = start_response(status, response_headers)
    return [output]

#here run the application
result = router.route(environ, start_response)
for value in result: 
    write(value)
</code></pre><p>注：上面的代码来自<a href="http://linluxiang.iteye.com/blog/799163" target="_blank" rel="noopener">这篇博客</a>。</p>
<h2 id="了解更多？"><a href="#了解更多？" class="headerlink" title="了解更多？"></a>了解更多？</h2><p>对于普通的开发者来说，了解到上面的知识已经足够，并不需要掌握每一个细节。</p>
<blockquote>
<p>Only authors of web servers and programming frameworks need to know every detail and corner case of the WSGI design. You don’t need to understand every detail of WSGI just to install a WSGI application or to write a web application using an existing framework.</p>
</blockquote>
<p>想要更多的话，就去看 <a href="http://legacy.python.org/dev/peps/pep-0333/#rationale-and-goals" target="_blank" rel="noopener">PEP333</a>，文档里还有下面更多的知识：</p>
<ul>
<li>错误处理</li>
<li>environ 变量包含哪些值，都是什么意思。</li>
<li>输入和输出的细节</li>
<li>start_response 的更多规范</li>
<li>content-length 等头部规范</li>
<li>缓存和文本流</li>
<li>unicode 和多语言处理</li>
<li>……</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://legacy.python.org/dev/peps/pep-0333/#rationale-and-goals" target="_blank" rel="noopener">官方文档 PEP333</a></li>
<li><a href="http://lucumr.pocoo.org/2007/5/21/getting-started-with-wsgi/" target="_blank" rel="noopener">Getting Started with WSGI</a></li>
<li><a href="http://blog.csdn.net/yangz_xx/article/details/37508909" target="_blank" rel="noopener">一篇很简洁易懂的 wsgi 介绍</a></li>
<li><a href="https://docs.python.org/2/library/wsgiref.html" target="_blank" rel="noopener">wsgiref：官方的 wsgi 实现，包括客户端和服务器端</a></li>
</ul>

                </div>
            </section>
        </article>
    </div>
    
<nav class="pagination">
    
    
    <a class="prev-post" title="wsgiref 源码解析" href="/2014/11/09/dive-into-wsgiref/">
        ← wsgiref 源码解析
    </a>
    
    <span class="prev-next-post">•</span>
    
    <a class="next-post" title="Linux 文本处理" href="/2014/10/19/text-manipulation-in-linux/">
        Linux 文本处理 →
    </a>
    
    
</nav>
    
</main>

<div class="t-g-control">
    <div class="gotop">
        <svg class="icon" width="32px" height="32px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M793.024 710.272a32 32 0 1 0 45.952-44.544l-310.304-320a32 32 0 0 0-46.4 0.48l-297.696 320a32 32 0 0 0 46.848 43.584l274.752-295.328 286.848 295.808z" fill="#8a8a8a" /></svg>
    </div>
    <div class="toc-control">
        <svg class="icon toc-icon" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M779.776 480h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M779.776 672h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M256 288a32 32 0 1 0 0 64 32 32 0 0 0 0-64M392.576 352h387.2a32 32 0 0 0 0-64h-387.2a32 32 0 0 0 0 64M256 480a32 32 0 1 0 0 64 32 32 0 0 0 0-64M256 672a32 32 0 1 0 0 64 32 32 0 0 0 0-64" fill="#8a8a8a" /></svg>
        <svg class="icon toc-close" style="display: none;" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M512 960c-247.039484 0-448-200.960516-448-448S264.960516 64 512 64 960 264.960516 960 512 759.039484 960 512 960zM512 128.287273c-211.584464 0-383.712727 172.128262-383.712727 383.712727 0 211.551781 172.128262 383.712727 383.712727 383.712727 211.551781 0 383.712727-172.159226 383.712727-383.712727C895.712727 300.415536 723.551781 128.287273 512 128.287273z" fill="#8a8a8a" /><path d="M557.05545 513.376159l138.367639-136.864185c12.576374-12.416396 12.672705-32.671738 0.25631-45.248112s-32.704421-12.672705-45.248112-0.25631l-138.560301 137.024163-136.447897-136.864185c-12.512727-12.512727-32.735385-12.576374-45.248112-0.063647-12.512727 12.480043-12.54369 32.735385-0.063647 45.248112l136.255235 136.671523-137.376804 135.904314c-12.576374 12.447359-12.672705 32.671738-0.25631 45.248112 6.271845 6.335493 14.496116 9.504099 22.751351 9.504099 8.12794 0 16.25588-3.103239 22.496761-9.247789l137.567746-136.064292 138.687596 139.136568c6.240882 6.271845 14.432469 9.407768 22.65674 9.407768 8.191587 0 16.352211-3.135923 22.591372-9.34412 12.512727-12.480043 12.54369-32.704421 0.063647-45.248112L557.05545 513.376159z" fill="#8a8a8a" /></svg>
    </div>
    <div class="gobottom">
        <svg class="icon" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M231.424 346.208a32 32 0 0 0-46.848 43.584l297.696 320a32 32 0 0 0 46.4 0.48l310.304-320a32 32 0 1 0-45.952-44.544l-286.848 295.808-274.752-295.36z" fill="#8a8a8a" /></svg>
    </div>
</div>
<div class="toc-main" style="right: -100%">
    <div class="post-toc">
        <span>TOC</span>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#基础知识"><span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-知识"><span class="toc-text">Python 知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-基础"><span class="toc-text">HTTP 基础</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WSGI"><span class="toc-text">WSGI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#应用程序端"><span class="toc-text">应用程序端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务器程序端"><span class="toc-text">服务器程序端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中间层-middleware"><span class="toc-text">中间层 middleware</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#了解更多？"><span class="toc-text">了解更多？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li></ol>
    </div>
</div>



        

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
            

<article class="read-next-card"  style="background-image: url(https://i.loli.net/2017/11/26/5a19c56faa29f.jpg)"  >
  <header class="read-next-card-header">
    <small class="read-next-card-header-sitetitle">&mdash; Cizixs Write Here &mdash;</small>
    <h3 class="read-next-card-header-title">Recent Posts</h3>
  </header>
  <div class="read-next-divider">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/>
    </svg>
  </div>
  <div class="read-next-card-content">
    <ul>
      
      
      
      <li>
        <a href="/2018/08/26/what-is-istio/">什么是 istio</a>
      </li>
      
      
      
      <li>
        <a href="/2018/08/25/knative-serverless-platform/">serverless 平台 knative 简介</a>
      </li>
      
      
      
      <li>
        <a href="/2018/06/25/kubernetes-resource-management/">kubernetes 资源管理概述</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
  <footer class="read-next-card-footer">
    <a href="/archives">  MORE  → </a>
  </footer>
</article>

            
            
            
        </div>
    </div>
</aside>

<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<section class="copyright">
			<a href="/" title="Cizixs Write Here">Cizixs Write Here</a>
			&copy; 2018
		</section>
		<nav class="site-footer-nav">
			
            <a href="https://hexo.io" title="Hexo" target="_blank" rel="noopener">Hexo</a>
            <a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
        </nav>
    </div>
</footer>






<div class="floating-header" >
	<div class="floating-header-logo">
        <a href="/" title="Cizixs Write Here">
			
                <img src="https://i.loli.net/2017/11/26/5a19c0b50432e.png" alt="Cizixs Write Here icon" />
			
            <span>Cizixs Write Here</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">python wsgi 简介</div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>
<script>
   $(document).ready(function () {
    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');
    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }
    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }
    function update() {
        var rect = title.getBoundingClientRect();
        var trigger = rect.top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;
            // show/hide floating header
            if (lastScrollY >= trigger + triggerOffset) {
                header.classList.add('floating-active');
            } else {
                header.classList.remove('floating-active');
            }
            progressBar.setAttribute('max', progressMax);
            progressBar.setAttribute('value', lastScrollY);
            ticking = false;
        }

        window.addEventListener('scroll', onScroll, {passive: true});
        update();

        // TOC
        var width = $('.toc-main').width();
        $('.toc-control').click(function () {
            if ($('.t-g-control').css('width')=="50px") {
                if ($('.t-g-control').css('right')=="0px") {
                    $('.t-g-control').animate({right: width}, "slow");
                    $('.toc-main').animate({right: 0}, "slow");
                    toc_icon()
                } else {
                    $('.t-g-control').animate({right: 0}, "slow");
                    $('.toc-main').animate({right: -width}, "slow");
                    toc_icon()
                }
            } else {
                if ($('.toc-main').css('right')=="0px") {
                    $('.toc-main').slideToggle("fast", toc_icon());
                } else {
                    $('.toc-main').css('right', '0px');
                    toc_icon()
                }
            }
        })

        function toc_icon() {
            if ($('.toc-icon').css('display')=="none") {
                $('.toc-close').hide();
                $('.toc-icon').show();
            } else {
                $('.toc-icon').hide();
                $('.toc-close').show();
            }
        }

        $('.gotop').click(function(){
            $('html,body').animate({scrollTop:$('.post-full-header').offset().top}, 800);
        });
        $('.gobottom').click(function () {
            $('html,body').animate({scrollTop:$('.pagination').offset().top}, 800);
        });

        // highlight
        // https://highlightjs.org
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
        $('td.code').each(function(i, block) {
            hljs.highlightBlock(block);
        });

        console.log("this theme is from https://github.com/xzhih/hexo-theme-casper")
    });
</script>



<link rel="stylesheet" href="https://cdn.staticfile.org/lightgallery/1.3.9/css/lightgallery.min.css">



<script src="https://cdn.staticfile.org/lightgallery/1.3.9/js/lightgallery.min.js"></script>


<script>
	$(function () {
		var postImg = $('#lightgallery').find('img');
		postImg.addClass('post-img');
		postImg.each(function () {
			var imgSrc = $(this).attr('src');
			$(this).attr('data-src', imgSrc);
		});
		$('#lightgallery').lightGallery({selector: '.post-img'});
	});
</script>




    </div>
</body>
</html>
